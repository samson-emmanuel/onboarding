<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Contacts | Onboarding Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-gray-900 to-gray-800 shadow-xl">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <a href="#" id="logoLink" class="flex items-center gap-3">
        <img src="images/lafarge-onboarding-app.png" alt="Onboarding Portal Logo" class="w-10 h-10">
        <span class="text-white font-bold text-xl">Onboarding Portal</span>
      </a>
      <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg transition">
        Logout
      </button>
    </div>
  </nav>

  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-600 to-indigo-700 shadow-2xl text-white py-16">
    <div class="max-w-7xl mx-auto px-6 text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold mb-4">All Contacts Directory</h1>
      <p class="text-xl opacity-90">Emergency services, Lafarge team, embassies, and HR support</p>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-12">

    <!-- Loading -->
    <div id="loading" class="text-center py-20">
      <div class="inline-flex items-center gap-4 text-blue-600">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
        <span class="text-2xl font-medium">Loading contacts...</span>
      </div>
    </div>

    <!-- Error -->
    <div id="error" class="hidden bg-red-50 border border-red-200 text-red-800 px-6 py-4 rounded-lg mb-8">
      <strong>Error:</strong> <span></span>
    </div>

    <!-- Emergency -->
    <div id="emergencySection" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden mb-10">
      <div class="bg-gradient-to-r from-red-500 to-rose-600 text-white p-8">
        <h2 class="text-3xl font-bold">Emergency Services</h2>
      </div>
      <div class="p-8">
        <ul id="emergencyList" class="space-y-6"></ul>
        <div id="emergencyNoData" class="text-center text-gray-500 py-12 text-lg hidden">
          No emergency information available.
        </div>
      </div>
    </div>

    <!-- Lafarge -->
    <div id="lafargeSection" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden mb-10">
      <div class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-8">
        <h2 class="text-3xl font-bold">Lafarge Contacts</h2>
      </div>
      <div class="p-8">
        <div class="overflow-x-auto rounded-lg border">
          <table id="lafargeTable" class="min-w-full divide-y divide-gray-200 hidden">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Function</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Name</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase">Phone</th>
              </tr>
            </thead>
            <tbody id="lafargeBody" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
        <div id="lafargeNoData" class="text-center text-gray-500 py-12 text-lg hidden">
          No Lafarge contacts available.
        </div>
      </div>
    </div>

    <!-- Coming Soon Sections -->
    <div id="embassiesSection" class="hidden bg-white rounded-2xl shadow-xl p-16 text-center mb-10">
      <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-8 rounded-2xl">
        <h2 class="text-3xl font-bold">Embassies</h2>
        <p class="text-xl mt-4 opacity-90">Contact information coming soon</p>
      </div>
    </div>

    <div id="hrSection" class="hidden bg-white rounded-2xl shadow-xl p-16 text-center">
      <div class="bg-gradient-to-r from-orange-500 to-amber-600 text-white p-8 rounded-2xl">
        <h2 class="text-3xl font-bold">HR Contacts</h2>
        <p class="text-xl mt-4 opacity-90">HR team details coming soon</p>
      </div>
    </div>

  </main>

  <!-- EXACT ORIGINAL JAVASCRIPT â€” 100% UNTOUCHED, ONLY FORMATTED -->
  <script>
    const userStr = localStorage.getItem('user');
    if (!userStr) {
        window.location.href = 'login.html';
    } else {
        try {
            JSON.parse(userStr);
        } catch (e) {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
    }

    async function getAllContacts() {
        const baseUrl = 'https://onboardingservice-812204315267.europe-west1.run.app/api';
        const token = localStorage.getItem('authToken');
        const url = `${baseUrl}/Contacts/get-all`;
        const headers = {
            'accept': 'text/plain',
            ...(token && { 'Authorization': `Bearer ${token}` })
        };
        console.log('Get All Contacts request headers:', headers);

        try {
            const response = await fetch(url, { headers });
            console.log('Get All Contacts response status:', response.status);
            const jsonResponse = await response.json();
            if (jsonResponse.isSuccessful && jsonResponse.result) {
                return jsonResponse.result;
            } else {
                throw new Error(jsonResponse.Message || 'Failed to load all contacts');
            }
        } catch (e) {
            console.log('Network error fetching all contacts:', e);
            throw new Error(`Network error fetching all contacts: ${e.message}`);
        }
    }

    function renderEmergency(emergency) {
        const list = document.getElementById('emergencyList');
        const noData = document.getElementById('emergencyNoData');
        const section = document.getElementById('emergencySection');

        if (!emergency || emergency.length === 0) {
            noData.style.display = 'block';
            section.style.display = 'block';
            return;
        }

        list.innerHTML = '';
        emergency.forEach(item => {
            const li = document.createElement('li');
            li.className = 'bg-gray-50 p-6 rounded-xl border';
            li.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div>
                        <p class="font-bold text-lg text-gray-900">${item.service}</p>
                        <p class="text-gray-700 mt-1">${item.info}</p>
                    </div>
                </div>
            `;
            list.appendChild(li);
        });

        section.style.display = 'block';
    }

    function renderLafarge(lafarge) {
        const tbody = document.getElementById('lafargeBody');
        const table = document.getElementById('lafargeTable');
        const noData = document.getElementById('lafargeNoData');
        const section = document.getElementById('lafargeSection');

        if (!lafarge || lafarge.length === 0) {
            noData.style.display = 'block';
            section.style.display = 'block';
            return;
        }

        tbody.innerHTML = '';
        lafarge.forEach(contact => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-6 py-5 text-sm text-gray-600">${contact.function || ''}</td>
                <td class="px-6 py-5 text-sm font-semibold text-gray-900">${contact.name || ''}</td>
                <td class="px-6 py-5 text-sm">
                    ${contact.phone ? `<a href="tel:${contact.phone.replace(/\D/g, '')}" class="text-blue-600 hover:underline font-medium">${contact.phone}</a>` : '<span class="text-gray-400">-</span>'}
                </td>
            `;
            tbody.appendChild(row);
        });

        table.style.display = 'table';
        section.style.display = 'block';
    }

    function renderEmptySections() {
        document.getElementById('embassiesSection').style.display = 'block';
        document.getElementById('hrSection').style.display = 'block';
    }

    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        const errorDiv = document.getElementById('error');
        errorDiv.querySelector('span').textContent = message;
        errorDiv.style.display = 'block';
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }

    function setLogoLink() {
        const logoLink = document.getElementById('logoLink');
        if (!logoLink) return;

        let userRole = '';
        const userStr = localStorage.getItem('user');
        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                userRole = user.role;
            } catch (e) {
                console.error("Error parsing user data from localStorage for logo link", e);
                localStorage.removeItem('user');
            }
        }

        if (userRole) {
            const rolePage = `index-${userRole.toLowerCase().replace('_', '-')}.html`;
            logoLink.href = rolePage;
        } else {
            logoLink.href = 'login.html'; // Default to login if no role is found
        }
    }

    window.addEventListener('load', async () => {
        setLogoLink(); // Set the logo link on page load
        try {
            const contacts = await getAllContacts();
            renderEmergency(contacts.emergency);
            renderLafarge(contacts.lafarge);
            renderEmptySections();
        } catch (error) {
            console.error('Error loading contacts:', error);
            showError(error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    });
  </script>
</body>
</html>