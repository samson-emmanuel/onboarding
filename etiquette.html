<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Social Etiquette | Onboarding Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'deep-green': '#006400',
            'light-green': '#008000',
            'text-green': '#2E8B57',
            'deep-red': '#8B0000',
          }
        }
      }
    }
  </script>
  <style>
    /* Tailwind's @apply is not processed when using the CDN; replace with equivalent CSS */
    .card-hover {
      transition: all 300ms ease;
      will-change: transform;
    }

    .card-hover:hover {
      transform: translateY(-0.75rem); /* matches -translate-y-3 */
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* approximate shadow-2xl */
    }

    #regionalGrid > div, #impressionList > div {
      flex: 0 0 90%;
      scroll-snap-align: center;
    }
    @media (min-width: 768px) {
      #regionalGrid > div, #impressionList > div {
        flex-basis: 45%;
      }
    }
    @media (min-width: 1280px) {
      #regionalGrid > div {
        flex-basis: 30%;
      }
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-100 via-gray-200 to-gray-300">

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-deep-green to-light-green shadow-2xl border-b border-gray-700">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <a href="#" id="logoLink" class="flex items-center gap-3">
        <img src="images/lafarge-onboarding-app.png" alt="Onboarding Portal Logo" class="w-10 h-10">
        <span class="text-white font-bold text-xl tracking-tight">Onboarding Portal</span>
      </a>
      <button onclick="logout()" class="bg-deep-red hover:bg-deep-red text-white font-bold py-2.5 px-8 rounded-lg shadow-lg hover:shadow-xl transition transform hover:scale-105">
        Logout
      </button>
    </div>
  </nav>

  <!-- Hero Header -->
  <header class="bg-gradient-to-r from-deep-green via-light-green to-green-700 shadow-2xl text-white py-20">
    <div class="max-w-7xl mx-auto px-6 text-center">
      <h1 class="text-5xl md:text-6xl font-extrabold mb-6">
        Social Etiquette in Nigeria
      </h1>
      <p class="text-2xl opacity-95 max-w-4xl mx-auto leading-relaxed">
        Key cultural insights to help you connect respectfully across Nigeria’s rich and diverse regions
      </p>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-16">

    <!-- Loading -->
    <div id="loading" class="text-center py-20">
      <div class="inline-flex items-center gap-4 text-deep-green">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-deep-green border-t-transparent"></div>
        <span class="text-2xl font-bold">Loading cultural guide...</span>
      </div>
    </div>

    <!-- Error -->
    <div id="error" class="hidden mb-12 bg-red-100 border-l-4 border-deep-red p-8 rounded-xl shadow-lg">
      <div class="flex items-start gap-4">
        <svg class="w-8 h-8 text-deep-red flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
        </svg>
        <p class="text-deep-red font-semibold text-lg"></p>
      </div>
    </div>

    <!-- Regional Cultural Insights -->
    <section id="regionalSection" class="hidden mb-20">
      <div class="text-center mb-12">
        <h2 class="text-4xl font-extrabold text-gray-800 mb-4">Regional Cultural Insights</h2>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Understanding local customs helps build trust and strong relationships
        </p>
      </div>

      <div id="regionalGrid" class="flex overflow-x-auto snap-x snap-mandatory gap-10 py-4 no-scrollbar"></div>
      <p class="text-center text-gray-500 text-sm mt-2">Swipe to view more details &#8594;</p>
    </section>

    <!-- First Impression Tips -->
    <section id="firstImpressionSection" class="hidden">
      <div class="text-center mb-12">
        <h2 class="text-4xl font-extrabold text-gray-800 mb-4">Making a Great First Impression</h2>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Simple gestures that show respect and openness go a long way
        </p>
      </div>

      <div id="impressionList" class="flex overflow-x-auto snap-x snap-mandatory gap-10 py-4 no-scrollbar"></div>
      <p class="text-center text-gray-500 text-sm mt-2">Swipe to view more details &#8594;</p>
    </section>

  </main>

  <!-- Footer -->
  <footer class="mt-24 py-12 bg-deep-green text-white text-center">
    <p>© 2025 Onboarding Portal • Building Bridges Through Understanding</p>
  </footer>

  <script>
    const userStr = localStorage.getItem('user');
    if (!userStr) {
        window.location.href = 'index.html';
    } else {
        try {
            JSON.parse(userStr);
        } catch (e) {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    }
  
    function logout() {
        localStorage.clear();
        window.location.href = 'index.html';
    }

    async function getEtiquette() {
        console.log('Inside getEtiquette');
        const baseUrl = 'https://onboardingservice-812204315267.europe-west1.run.app/api';
        const token = localStorage.getItem('authToken');
        const url = `${baseUrl}/Content/get-etiquette`;
        const headers = {
            'accept': 'text/plain',
            ...(token && { 'Authorization': `Bearer ${token}` })
        };

        try {
            const response = await fetch(url, { headers });
            console.log('Get Etiquette response status:', response.status);
            if (response.status === 200) {
                const jsonResponse = await response.json();
                console.log('Get Etiquette response json:', jsonResponse);
                if (jsonResponse.isSuccessful && jsonResponse.result) {
                    return jsonResponse.result;
                } else {
                    throw new Error(`Failed to load etiquette: ${jsonResponse.message}`);
                }
            } else {
                throw new Error(`Failed to load etiquette: ${response.status}. ${await response.text()}`);
            }
        } catch (e) {
            console.error(`Network error fetching etiquette: ${e.message}`);
            throw new Error(`Network error fetching etiquette: ${e.message}`);
        }
    }

    function renderRegionalInfo(data) {
        console.log('Inside renderRegionalInfo', data);
        const section = document.getElementById('regionalSection');
        const grid = document.getElementById('regionalGrid');

        grid.innerHTML = '';
        (data.regionalInfo || []).forEach(category => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-3xl shadow-xl overflow-hidden card-hover border border-amber-100';

            let regionsHTML = '';
            category.regions.forEach(region => {
                regionsHTML += `
                    <div class="p-6 border-b border-gray-100 last:border-0">
                        <h4 class="text-xl font-bold text-amber-700 mb-2 flex items-center gap-2">
                            <span class="text-2xl">•</span> ${region.title}
                        </h4>
                        <p class="text-gray-700 leading-relaxed">${region.content || ''}</p>
                    </div>
                `;
            });

            card.innerHTML = `
                <div class="bg-gradient-to-r from-amber-500 to-orange-600 text-white p-6">
                    <h3 class="text-2xl font-extrabold">${category.title}</h3>
                </div>
                <div class="divide-y divide-gray-100">
                    ${regionsHTML}
                </div>
            `;
            grid.appendChild(card);
        });

        if ((data.regionalInfo || []).length > 0) {
            section.style.display = 'block';
        }
    }

    function renderFirstImpressions(data) {
        console.log('Inside renderFirstImpressions', data);
        const section = document.getElementById('firstImpressionSection');
        const list = document.getElementById('impressionList');

        list.innerHTML = '';
        (data.firstImpression || []).forEach(item => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-3xl shadow-xl p-10 card-hover border border-orange-100';
            card.innerHTML = `
                <div class="flex items-start gap-5">
                    <div class="flex-shrink-0 w-14 h-14 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center shadow-lg">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-3">${item.title}</h3>
                        <p class="text-gray-700 text-lg leading-relaxed whitespace-pre-wrap">${item.content || ''}</p>
                    </div>
                </div>
            `;
            list.appendChild(card);
        });

        if ((data.firstImpression || []).length > 0) {
            section.style.display = 'block';
        }
    }

    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        const errorDiv = document.getElementById('error');
        errorDiv.querySelector('p') ? errorDiv.querySelector('p').textContent = message : errorDiv.innerHTML = `<p class="text-red-800 font-semibold text-lg">${message}</p>`;
        errorDiv.style.display = 'block';
    }

    function setLogoLink() {
        const logoLink = document.getElementById('logoLink');
        if (!logoLink) return;

        let userRole = '';
        const userStr = localStorage.getItem('user');
        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                userRole = user.role;
            } catch (e) {
                console.error("Error parsing user data from localStorage for logo link", e);
                localStorage.removeItem('user');
            }
        }


        if (userRole) {
            const rolePage = `index-${userRole.toLowerCase().replace('_', '-')}.html`;
            logoLink.href = rolePage;
        } else {
            logoLink.href = 'index.html'; // Default to login if no role is found
        }
    }

    window.addEventListener('load', async () => {
        console.log('load event listener started');
        setLogoLink(); // Set the logo link on page load
        try {
            console.log('Calling getEtiquette');
            const data = await getEtiquette();
            console.log('getEtiquette returned', data);
            renderRegionalInfo(data);
            renderFirstImpressions(data);
        } catch (error) {
            console.error('Error loading etiquette:', error);
            showError(error.message);
        } finally {
            console.log('load event listener finished');
            document.getElementById('loading').style.display = 'none';
        }
    });
  </script>
</body>
</html>